name: Build RustDesk Client

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # 当推送 v 开头的标签时触发
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许在 GitHub 网页上手动触发
    inputs:
      platform:
        description: 'Target platform'
        required: true
        default: 'windows'
        type: choice
        options:
        - windows
        - linux
        - macos

# 在这里定义全局环境变量
env:
  # 这些变量会从 GitHub Secrets 中读取
  RUSTDESK_RELAY_SERVER: ${{ secrets.RELAY_SERVER }}
  RUSTDESK_KEY: ${{ secrets.ENCRYPTION_KEY }}
  RUSTDESK_API_SERVER: ${{ secrets.API_SERVER }}
  # 其他构建配置
  BUILD_TYPE: "release"
  CARGO_TERM_COLOR: always

jobs:
  build-windows:
    # 如果手动触发，根据输入的平台决定是否运行
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'windows' || github.event_name != 'workflow_dispatch'
    runs-on: windows-latest  # 使用 Windows 最新版
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive  # RustDesk 需要子模块
        fetch-depth: 0
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        channel: stable
        cache: true
        cache-key: flutter-cache
        
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
        override: true
        components: rustfmt, clippy
        
    - name: Install Windows dependencies
      run: |
        # 安装 RustDesk 需要的 Windows 依赖
        choco install -y llvm cmake ninja
        # 如果需要的话，安装其他工具
        # choco install -y nasm
        
    - name: Configure RustDesk
      run: |
        # 创建配置文件，使用环境变量
        $configContent = @"
[network]
relay_server = "$env:RUSTDESK_RELAY_SERVER"
api_server = "$env:RUSTDESK_API_SERVER"

[security]
key = "$env:RUSTDESK_KEY"

[options]
enable_sound = true
enable_file_transfer = true
"@
        # 保存配置文件
        $configContent | Out-File -FilePath "config.toml" -Encoding UTF8
        # 显示配置文件（不显示敏感信息）
        Write-Output "Config file created (without sensitive data)"
        
    - name: Build Rust library
      run: |
        cd libs
        # 启用硬件编码支持
        cargo build --release --features "hwcodec"
        # 复制库文件到 Flutter 项目
        cp target/release/*.dll ../flutter/windows/runner/Release/
        
    - name: Build Flutter application
      run: |
        cd flutter
        # 获取 Flutter 依赖
        flutter pub get
        # 构建 Windows 应用
        flutter build windows --release
        # 列出生成的文件
        dir build\windows\runner\Release\
        
    - name: Upload Windows artifact
      uses: actions/upload-artifact@v3
      with:
        name: rustdesk-windows
        path: flutter/build/windows/runner/Release/
        retention-days: 7

  build-linux:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.platform == 'linux' || github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        submodules: recursive
        
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      
    - name: Setup Rust
      uses: actions-rs/toolchain@v1
      
    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev libxdo-dev libxcb-shape0-dev libxcb-xfixes0-dev
        sudo apt-get install -y cmake ninja-build clang
        
    - name: Build for Linux
      run: |
        # 类似 Windows 的构建步骤
        cd libs
        cargo build --release
        cd ../flutter
        flutter build linux --release
        
    - name: Upload Linux artifact
      uses: actions/upload-artifact@v3
      with:
        name: rustdesk-linux
        path: flutter/build/linux/release/

  # 可以添加更多平台：macos、android 等

  # 清理步骤（可选）
  cleanup:
    needs: [build-windows, build-linux]
    if: always()
    runs-on: ubuntu-latest
    steps:
    - name: Cleanup notification
      run: |
        echo "Build completed at $(date)"
        echo "Check artifacts for the built binaries"